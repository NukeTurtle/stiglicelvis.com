name: Update Starred Repos

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Create _data directory
        run: mkdir _data
      
      - name: Fetch and save starred repos
        run: |
          set -e
          # token=${{ secrets.API_KEY }}
          url="https://api.github.com/users/NukeTurtle/starred"
          starred_repos=$(curl -sS --request GET --url "$url" | jq '[.[] | { name: .full_name, url: .url }]')
          # starred_repos=$(curl -sS --request GET --header "PRIVATE-TOKEN: $GITHUB_TOKEN" $url | jq '[.[] | { name: .full_name, url: .url }]')
          # curl -sS --request GET --header "PRIVATE-TOKEN: $GIT_TOKEN" "$GIT_API/groups/1079" | jq -r ".description"
          echo "$starred_repos" > _data/starred_repos.json
          echo "Starred repositories fetched and saved successfully."
      - name: Configure Git
        run: |
          set -e
          git init
          git credential-cache exit
          git config --global url.https://${{ secrets.PAT_TOKEN }}@github.com/.insteadOf https://github.com/
          git config --global user.name 'NukeTurtle'
          git config --global user.email 'stiglic.elvis@gmail.com'
          git remote add origin https://github.com/NukeTurtle/stiglicelvis.com.git
          git remote set-url origin https://github.com/NukeTurtle/stiglicelvis.com.git
          # git checkout -b main
          git pull origin main
      - name: Commit changes
        run: |
          set -e
          git add .
          git commit -m 'Update _data folder with starred repos'
        working-directory: ${{ github.workspace }}/_data
      
      - name: Push changes
        run: |
          set -e
          git push --force --set-upstream origin main
        working-directory: ${{ github.workspace }}/_data
